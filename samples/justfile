root_dir  := justfile_directory()
linker    := root_dir + "/../target/x86_64-unknown-linux-none/debug/fold"
seccomp-linker := root_dir + "/../examples/target/x86_64-unknown-linux-none/debug/seccomp-linker"
emulator-linker := root_dir + "/../examples/target/x86_64-unknown-linux-none/debug/emulator-linker"
seccomp-sym-linker := root_dir + "/../examples/target/x86_64-unknown-linux-none/debug/seccomp-sym-linker"
trampoline-linker := root_dir + "/../examples/target/x86_64-unknown-linux-none/debug/trampoline-linker"

programs:
	# hello
	nasm -f elf64 hello.asm
	ld hello.o -o hello

	# hello-pie
	nasm -f elf64 hello-pie.asm
	ld -pie --dynamic-linker {{linker}} hello-pie.o -o hello-pie

	# hello-mov-pie
	nasm -f elf64 hello-mov-pie.asm
	ld -pie --dynamic-linker {{linker}} hello-mov-pie.o -o hello-mov-pie

	# hello-dl
	nasm -f elf64 hello-dl.asm
	nasm -f elf64 msg.asm
	ld -shared msg.o -o libmsg.so
	ld -rpath {{root_dir}} -pie --dynamic-linker {{linker}} hello-dl.o libmsg.so -o hello-dl

	# hello.c 
	gcc -o hello-c hello.c -pie -fPIE
	patchelf --set-interpreter {{linker}} hello-c
	patchelf --replace-needed libc.so.6 ../musl/lib/libc.so hello-c

	# hello-args.c
	gcc -o hello-args hello-args.c -pie -fPIE
	patchelf --set-interpreter {{linker}} hello-args
	patchelf --replace-needed libc.so.6 ../musl/lib/libc.so hello-args

	# hello-bss.c
	gcc -o hello-bss hello-bss.c -pie -fPIE
	patchelf --set-interpreter {{linker}} hello-bss
	patchelf --replace-needed libc.so.6 ../musl/lib/libc.so hello-bss

	# hello-env.c 
	gcc -o hello-env hello-env.c -pie -fPIE
	patchelf --set-interpreter {{linker}} hello-env
	patchelf --replace-needed libc.so.6 ../musl/lib/libc.so hello-env

	# hello-math.c 
	gcc -o hello-math hello-math.c -pie -fPIE -lm
	patchelf --set-interpreter {{linker}} hello-math
	patchelf --replace-needed libc.so.6 ../musl/lib/libc.so hello-math

	# seccomp-allowed.c
	gcc -o seccomp-allowed seccomp-allowed.c -pie -fPIE -lm
	patchelf --set-interpreter {{seccomp-linker}} seccomp-allowed
	patchelf --replace-needed libc.so.6 ../musl/lib/libc.so seccomp-allowed

	# seccomp-forbidden.c
	gcc -o seccomp-forbidden seccomp-forbidden.c -pie -fPIE -lm
	patchelf --set-interpreter {{seccomp-linker}} seccomp-forbidden
	patchelf --replace-needed libc.so.6 ../musl/lib/libc.so seccomp-forbidden

	# trampoline-print
	gcc -o trampoline-print hello.c -pie -fPIE -lm
	patchelf --set-interpreter {{trampoline-linker}} trampoline-print
	patchelf --replace-needed libc.so.6 ../musl/lib/libc.so trampoline-print

	# hello.c 
	gcc -o seccomp-sym-hello-c hello.c -pie -fPIE
	patchelf --set-interpreter {{seccomp-sym-linker}} seccomp-sym-hello-c
	patchelf --replace-needed libc.so.6 ../musl/lib/libc.so seccomp-sym-hello-c

	# hello-threaded.c
	gcc -g count.c -shared -o libcount.so -fPIC
	gcc -g count-pic.c -shared -o libcount-pic.so -fPIC
	gcc -g hello-threaded.c -L . -l count -o hello-threaded -fPIC
	gcc -g hello-threaded-pic.c -L . -l count-pic -o hello-threaded-pic -fPIC

	patchelf --set-interpreter {{linker}} hello-threaded
	patchelf --set-interpreter {{linker}} hello-threaded-pic

riscv-programs:
	# hello-riscv (should have riscv build toolchain)
	riscv64-unknown-linux-gnu-gcc -o hello-riscv hello-riscv.s -nostdlib -static


clean:
	rm *.o -f
	rm *.so -f
	rm hello hello-dl hello-pie hello-mov-pie hello-c -f

# vim: set ft=make :
